#!/bin/sh

configure() {
	echo "Running configuration"
	[ -e "$HOME/.config/smail" ] || mkdir -p "$HOME/.config/smail"

	echo "Enter email:"
	read -r username
	echo "email=$(echo "$username" | base64 )" > "$configfile"

	echo "Enter password:"
	stty -echo
	read -r password
	stty echo
	echo "password=$(echo "$password" | base64 )" >> "$configfile"

	echo "Enter your favorite editor: [vi]"
	# shellcheck disable=SC2039
	read -re editor
	echo "editor=${editor:-vi}" >> "$configfile"
	echo Done
}

connect() {
	openssl s_client -quiet \
		-starttls smtp \
		-connect smtp.gmail.com:587 \
		-crlf < .in > .out 2> /dev/null &
	state=1

	echo ehlo smtp.gmail.com > .in
	state=2
}

add_attachments() {
	echo "Enter file path:"
	# shellcheck disable=SC2039
	read -er annex
	if [ -f "$annex" ]; then
		echo "Enter attachment name: [$(basename "$annex")]"
		read -r annexname
		[ "$annexname" = "" ] && annexname="$(basename "$annex")"

		echo "Content-Type: application/octet-stream" >> .temp
		echo "Content-Transfer-Encoding: base64" >> .temp
		echo "Content-Disposition: attachment;" >> .temp
		echo " filename= \"$annexname\"" >> .temp
		echo "" >> .temp
		base64 "$annex" >> .temp
	else
		echo "ERROR: File not found!"
	fi

	echo "Add another attachment(s)? [y/N]"
	read -r another
	[ "$another" = "y" ] && { echo "--$1" >> .temp; add_attachments "$1"; }
}

compose() {
	echo "Type recipient:"
	read -r to
	echo "To: $to" > .temp
	echo "From: $emaildec" >> .temp

	echo "Type subject:"
	read -r subj
	echo "Subject: $subj" >> .temp

	boundary="$(date | tr " :-" "wUX")"
	echo "MIME-Version: 1.0" >> .temp
	echo "Content-Type: multipart/mixed;" >> .temp
	echo " boundary= \"$boundary\"" >> .temp
	echo "" >> .temp
	
	echo "--$boundary" >> .temp
	echo 'Content-Type: text/plain; charset=US-ASCII' >> .temp
	echo "" >> .temp

	# echo "" > .body
	$editor .body
	sed 's/^.$/../' .body | fold -w 72 -s >> .temp
	rm .body

	echo "" >> .temp
	echo "--$boundary" >> .temp

	echo "Insert attachment(s)? [y/N]"
	read -r attach
	[ "$attach" = "y" ] && add_attachments "$boundary"

	echo "--$boundary--" >> .temp
}

retry() {
	echo Retrying...
	case $state in
		2)
			echo ehlo smtp.gmail.com > .in
			;;
		3)
			echo auth login > .in
			;;
		4)
			echo "$email" > .in
			;;
		5)
			echo "$password" > .in
			;;
		6)
			echo 'mail from: <'"$emaildec"'>' > .in
			;;
		7)
			echo "Type recipient:"
			read -r to
			echo Sending mail to "$to"
			echo rcpt to: '<'"$to"'>' > .in
			;;
	esac
}

# Configuration step
configfile="$HOME/.config/smail/smail.conf"
[ -e "$configfile" ] || configure

email=$(grep email "$configfile" | cut -d '=' -f 2)
emaildec=$(echo "$email" | base64 -d)
password=$(grep password "$configfile" | cut -d '=' -f 2)
editor=$(grep editor "$configfile" | cut -d '=' -f 2)

[ -p .in ] || mkfifo .in;
[ -p .out ] || mkfifo .out;

state=0


# start
openssl s_client -quiet -starttls smtp -connect smtp.gmail.com:587 -crlf < .in > .out 2> /dev/null &
state=1

echo Sending hello
echo ehlo smtp.gmail.com > .in
state=2
to=""

while :
do
	read -r msg < .out
	echo "received: $msg"
	case $msg in
		"250-"*)
			;;
		"250 SMTPUTF8"*)
			echo Logging in
			state=3
			echo auth login > .in
			;;
		"334 VXNlcm5hbWU6"*)
			echo Sending email
			state=4
			echo "$email" > .in
			;;

		"334 UGFzc3dvcmQ6"*)
			echo Sending password
			state=5
			echo "$password" > .in
			;;

		"235 2.7.0 Accepted"*)
			echo Logged in
			state=6
			echo 'mail from: <'"$emaildec"'>' > .in
			;;

		"250 2.0.0 OK"*)
			break
			;;

		"250 2.1.0 OK"*)
			echo "Type recipient:"
			read -r to
			echo Sending mail to "$to"
			state=7
			echo rcpt to: '<'"$to"'>' > .in
			;;

		"250 2.1.5 OK"*)
			echo data > .in
			;;

		"354  Go ahead"*)
			echo "To: $to" > .in
			echo "From: $emaildec" > .in
			
			echo "Input Subject:"
			read -r subj
			echo "Subject: $subj" > .in
			
			compose
			echo Done
			echo '.' > .in
			;;

		"451 4.4.2 Timeout"*)
			echo "Connection closed"
			break
			;;

		"501 5.5.2 Cannot Decode response"*)
			echo "Received error!"
			state=3
			retry
			;;
		"502 5.5.1 Unrecognized command"*)
			echo "Received error!"
			retry
			;;
		"503 5.5.1 MAIL first"*)
			echo "Received error!"
			state=6
			retry
			;;
		"530-5.7.0"*)
			;;
		"530 5.7.0"*)
			echo "Received error!"
			state=3
			retry
			;;
		"535 5.7.8"*)
			echo "Received error!"
			state=3
			retry
			;;
		"553 5.1.3"*)
			retry
			;;
		"554 5.7.0"*)
			echo "Received error!"
			break
			;;
		*)
			echo "Unrecognized message"
			break
			;;
	esac
done

echo Quitting
echo quit > .in

rm .in .out
