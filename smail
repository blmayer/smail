#!/bin/bash

usage() {
	echo "Smail v0.1.0: Send or read emails from your terminal."
	echo ""
	echo "Usage: smail [options] [command]"
	echo ""
	echo "Options:"
	echo "  -v		verbose output"
	echo "  -h		show this help"
	echo "  --help		show this help"
	echo "  --version	show version info"
	echo ""
	echo "Commands:"
	echo "  send		runs the send email interface"
	echo "  read		runs the read email CLI, default"
	echo "  config		runs the configuration script, also on first run"
	echo "  help		show this help"
	echo ""
	echo "Examples:"
	echo "  smail config	Run the configuration script"
	echo "  smail		Read emails"
	echo ""
	echo "Report bugs to: bleemayer@gmail.com"
	echo "Home page: <https://www.github.com/blmayer/smail/>"
	echo "General help: <https://www.github.com/blmayer/smail/wiki>"
}

show_version() {
	echo "smail 0.1.0"
	echo "Copyright (C) 2020 Brian Mayer."
	echo "License MIT: MIT License <https://opensource.org/licenses/MIT>"
	echo "THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,"
	echo "EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF"
	echo "MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT."
	echo ""
	echo "Written by Brian Lee Mayer."
}

read_opts() {
	for arg in "$@"
	do
		case $1 in
			"-v")
				debug=1
				;;
			"-h" | "help" | "--help")
				usage
				exit 0
				;;
			"--version")
				show_version
				exit 0
				;;
			"send")
				op="send"
				;;
			"read")
				op="read"
				;;
			"config")
				configure
				exit 0
				;;
			"-t"|"--to")
				shift
				to="$1"
				;;
			"--cc")
				shift
				cc="$1"
				;;
			"--cco")
				shift
				cco="$1"
				;;
			"-s"|"--subject")
				shift
				subj="$1"
				;;
			"-f"|"--file")
				shift
				body="$1"
				;;
			"")
				break
				;;
			*)
				echo "Unrecognized option $arg"
				usage
				exit 1
				;;
		esac
		shift
	done
}

configure() {
	echo "Running configuration"
	[ -e "$HOME/.config/smail" ] || mkdir -p "$HOME/.config/smail"

	echo "Enter email:"
	read -r username
	echo "email=$(echo "$username" | base64 )" > "$configfile"

	echo "Enter password:"
	stty -echo
	read -r password
	stty echo
	echo "password=$(echo "$password" | base64 )" >> "$configfile"

	echo "Enter your favorite editor: [vi]"
	# shellcheck disable=SC2039
	read -re editor
	echo "editor=${editor:-vi}" >> "$configfile"
	echo Done
}

send_smtp() {
	[ -e $debug ] || echo "Sending: $*"
	echo "$*" >&${SMTP[1]}
}

add_attachments() {
	echo "Enter file path:"
	# shellcheck disable=SC2039,SC2162
	read -e annex
	if [ -f "$annex" ]; then
		echo "Enter attachment name: [$(basename "$annex")]"
		read -r annexname
		[ "$annexname" = "" ] && annexname="$(basename "$annex")"

		{
			echo "Content-Type: application/octet-stream"
			echo "Content-Transfer-Encoding: base64"
			echo "Content-Disposition: attachment;"
			echo " filename= \"$annexname\""
			echo ""
		} >> .temp
		base64 "$annex" >> .temp
		[ -e $debug ] || echo "Added $annex with name: $annexname"
	else
		echo "ERROR: File not found!"
	fi

	echo "Add another attachment(s)? [y/N]"
	read -r another
	[ "$another" = "y" ] && { echo "--$1" >> .temp; add_attachments "$1"; }
}

get_rcpt() {
	echo "$to" | cut -d ',' -f "$1"
}

compose() {
	[[ -z "$to" ]] && {
		echo "Type recipient(s) (comma separated):"
		read -r to

		echo "Type Cc(s): (comma separated)"
		read -r cc

		echo "Type Cco(s): (comma separated)"
		read -r cco
	}

	echo "To: $to" > .temp
	echo "From: $emaildec" >> .temp
	[ -n "$cc" ] && { echo "Cc: $cc" >> .temp; to="$to,$cc"; }
	[ -n "$cco" ] && { echo "Cco: $cco" >> .temp; to="$to,$cco"; }

	# Transform into list for sending later
	n=$(($(echo "$to" | tr -d -c ',' | wc -c | xargs) + 1))

	[[ -z "$subj" ]] && {
		echo "Type subject:"
		read -r subj
	}
	echo "Subject: $subj" >> .temp

	[ -e $debug ] || echo "Email fields:"
	[ -e $debug ] || cat .temp

	boundary="$(date | tr " :-" "wUX")"
	{
		echo "MIME-Version: 1.0"
		echo "Content-Type: multipart/mixed;"
		echo " boundary= \"$boundary\""
		echo ""
	
		echo "--$boundary"
		echo 'Content-Type: text/plain; charset=US-ASCII'
		echo ""
	} >> .temp

	if [[ -e "$body" ]]
	then
		cp "$body" .body
	else
		$editor .body
	fi
	
	sed 's/^.$/../' .body | fold -w 72 -s >> .temp
	[ -e $debug ] || echo "Email body:"
	[ -e $debug ] || cat .body
	rm .body

	echo "" >> .temp
	echo "--$boundary" >> .temp

	echo "Insert attachment(s)? [y/N]"
	read -r attach
	[ "$attach" = "y" ] && add_attachments "$boundary"

	echo "--$boundary--" >> .temp
}

loop_smtp() {
	case "$state" in
	0)
		[ -e $debug ] || echo "logging in"
		send_smtp "ehlo smtp.gmail.com"
		state=1
		;;
	esac

	[ -e $debug ] || echo "listening"
	while read -r -u ${SMTP[0]} msg
	do
		[ -e $debug ] || echo "received: $msg"
		case $msg in
			"221 2.0.0"*)
				retry
				;;

			"250-"*)
				;;

			"250 SMTPUTF8"*)
				[ -e $debug ] || echo logging in
				state=3
				send_smtp "auth login"
				;;

			"334 VXNlcm5hbWU6"*)
				[ -e $debug ] || echo sending email
				state=4
				send_smtp "$email"
				;;

			"334 UGFzc3dvcmQ6"*)
				[ -e $debug ] || echo sending password
				state=5
				send_smtp "$password"
				;;

			"235 2.7.0"*)
				[ -e $debug ] || echo "logged in"
				state=6
				send_smtp 'mail from: <'"$emaildec"'>'
				;;

			"250 2.0.0"*)
				state=10
				rm .temp
				break
				;;

			"250 2.1.0"*)
				[ -e "$debug" ] || get_rcpt "$n"
				state=7
				send_smtp 'rcpt to: <'"$(get_rcpt $n)"'>'
				n=$((n - 1))
				;;

			"250 2.1.5"*)
				if [ ! $n = 0 ]
				then
					[ -e $debug ] || get_rcpt "$n"
					send_smtp 'rcpt to: <'"$(get_rcpt $n)"'>'
					n=$((n - 1))
				else
					[ -e $debug ] || echo "data"
					state=8
					send_smtp "data"
				fi
				;;

			"354  Go ahead"*)
				state=9
				cat .temp >&${SMTP[1]}
				send_smtp '.'
				;;

			"451 4.4.2 Timeout"*)
				[ -e $debug ] || echo "Connection closed"
				break
				;;

			"501 5.5.2 Cannot Decode response"*)
				state=3
				retry
		 		;;
			"502 5.5.1 Unrecognized command"*)
				retry
				;;
			"503 5.5.1 MAIL first"*)
				state=6
				retry
				;;
			"530-5.7.0"*)
				;;
			"530 5.7.0"*)
				state=3
				retry
				;;
			"535 5.7.8"*)
				state=3
				retry
				;;
			"553 5.1.3"*)
				retry
				;;
			"554 5.7.0"*)
				break
				;;
			"555 5.5.2 Syntax error"*)
				echo "FATAL ERROR email not sent"
				break
				;;
			*)
				[ -e $debug ] || echo "Unrecognized message"
				break
				;;
		esac
	done
}

### ---- IMAP Stuff ------------------------------------------------------ ###

decode_string() {
	# shellcheck disable=SC1112
	case "$@" in
	"=?iso-8859-1?Q?"*)
		echo "$@" | sed -e 's/=?iso-8859-1?Q?//Ig' \
		-e 's/?=//g' \
		-e 's/=E7/Ã§/g' \
		-e 's/=E3/Ã£/g'
		;;
	"=?utf-8?q?"* | "=?utf-8?Q?"*)
		echo "$@" | sed -e 's/.*=?utf-8?q?//Ig' \
		-e 's/?=//g' \
		-e 's/=F0=9F=8F=AD=C2=A0/ðŸ­/g' \
		-e 's/=C2=A0=F0=9F=91=87/ðŸ‘‡/g' \
		-e 's/=e2=80=93/-/g' \
		-e 's/=E2=80=99/â€™/g' \
		-e 's/=C3=BA/Ãº/g' \
		-e 's/=C3=B5/Ãµ/g' \
		-e 's/=C3=B4/Ã´/g' \
		-e 's/=C3=B3/Ã³/g' \
		-e 's/=C3=AD/Ã­/g' \
		-e 's/=C3=A9/Ã©/g' \
		-e 's/=C3=A7/Ã§/g' \
		-e 's/=C3=A3/Ã£/g' \
		-e 's/=C3=A1/Ã¡/g' \
		-e 's/=C3=A0/Ã /g' \
		-e 's/=3F/?/g' \
		-e 's/=2D/-/g' \
		-e 's/=2C/,/g' \
		-e 's/=20/ /g' \
		-e 's/=20/ /g' \
		-e 's/=20/ /g' \
		-e "s/=27/\\'/g" \
		-e 's/=28/(/g' \
		-e 's/=29/)/g' \
		-e 's/=21/!/g' \
		-e 's/=20/ /g'
		;;
	"=?UTF-8?B?"* | "=?utf-8?B?"*)
		echo "$@" | sed -e 's/=?UTF-8?B?//Ig' \
		-e 's/?=//g' | base64 -d
		;;
	*)
		echo "$@"
		;;
	esac
}

send_imap() {
	seq="$(printf '%d' $((seq+1)))"

	[ -e $debug ] || echo "Sending: a$seq $*"
	echo "a$seq $*" >&${IMAP[1]}
}

auth_imap() {
	[ -e $debug ] || echo "Authenticating"
	send_imap "login $emaildec $passworddec"

	while read -r -u ${IMAP[0]} msg
	do
		[ -e $debug ] || echo "received: $msg"
		case "$msg" in
		"a$seq OK"*)
			return 1
			break
			;;
	
		"a$seq BAD"*)
			break
			;;
		esac
	done

	return 0
}

select_inbox() {
	[ -e $debug ] || echo "Selecting inbox"
	send_imap "select inbox"
}

get_email() {
	send_imap "fetch $1 BODY.PEEK[HEADER]"

	while read -r -u ${IMAP[0]} msg
	do
		[ -e $debug ] || echo "received: $msg"
		case "$msg" in
		"a$seq OK"*)
			break
			;;
		'From:'*)
			from="$(cut -d ' ' -f 2 <<< "$msg" | tr -d '\r')"
			;;
		'Date:'*)
			date="$(cut -d ' ' -f 2-6 <<< "$msg" | tr -d '\r')"
			;;
		'Subject:'*)
			subj="$(cut -d ' ' -f 2- <<< "$msg" | tr -d '\r')"
			;;
		"a$seq BAD"*)
			break
			;;
		esac
	done

	from="$(echo "$from" | sed 's/ <.*>//')"
	from="$(decode_string "$from")"
	date="$(echo "$date" | cut -d ' ' -f 1-6)"
	subj="$(decode_string "$subj")"
	
	printf "%s\t\t%s\t%s\t\t%s" "$1" "$date" "$from" "$subj"
	echo ""
}

fetch_unseen() {
	[ -e $debug ] || echo "Fetching unread mail"
	send_imap "search unseen"

	# Read response
	[ -e $debug ] || echo "Reading response"
	while read -r -u ${IMAP[0]} msg
	do
		[ -e $debug ] || echo "received: $msg"
		case "$msg" in
			'* SEARCH'*)
				res="$(cut -d ' ' -f 3- <<< "$msg" | tr -d '\r')"
				;;
			"a$seq OK"*)
				break
				;;
			"a$seq BAD"*)
				return
				;;
		esac
	done

	# Parsing response
	[ -e $debug ] || echo "Getting individual mails $res"
	echo "id		date received			from			subject"
	for mail in $res
	do
		[ -e $debug ] || echo "Getting $mail"
		get_email "$mail"
	done
}

read_command() {
	echo "Type command:"
	echo "1) search	2) fetch	3) quit"

	read -r comm
	case "$comm" in
		"1" | "search")
			echo "Type search:"
			read -r search
			send_imap "search $search"
			;;
		"3" | "q" | "quit")
			send_imap "LOGOUT"
			exit 0
			;;
		*)
			echo "Not an option, type quit to quit"
			;;
	esac

	echo "reading"
	while read -r -u ${SMTP[1]} msg
	do
		[ -e $debug ] || echo "received: $msg"
	done

	[ -e $debug ] || echo "Getting individual mails"
	for mail in $res
	do
		[ -e $debug ] || echo "Sending: a$seq fetch $mail BODY[TEXT]"
		echo "a$seq fetch $mail BODY" > ${IMAP[1]}
		while read -r -u ${IMAP[0]} msg
		do
			[ -e $debug ] || echo "received: $msg"
			case "$msg" in
					"a$seq OK"*)
					break
					;;
				"a$seq BAD"*)
					break
					;;
			esac
		done 
	done
}


function loop_imap() {
	[ -e $debug ] || >&2 echo "Starting listener"
	while :
	do
		[ -e $debug ] || echo "In state $state"
		case $state in
			0)
				if auth_imap
				then
					state=1
				fi
				;;
			1)
				select_inbox
				state=2
				;;
			2)
				fetch_unseen
				state=3
				;;
			3)
				read_command
				;;
			8)
				;;
			9)
				break
				;;
			-1)
				echo "Error logging in, try again later"
				break
				;;
			*)
				[ -e $debug ] || echo "Unrecognized state"
				;;
		esac
	done 
}

### ---- Main program ---------------------------------------------------- ###

# Read arguments
configfile="$HOME/.config/smail/smail.conf"
read_opts "$@"

# Configuration step
[ -e "$configfile" ] || configure

email=$(grep email "$configfile" | cut -d '=' -f 2,3)
emaildec=$(echo "$email" | base64 -d)
password=$(grep password "$configfile" | cut -d '=' -f 2,3)
passworddec=$(echo "$password" | base64 -d)
editor=$(grep editor "$configfile" | cut -d '=' -f 2)

case "$op" in 
	"send")
		coproc SMTP {
			openssl s_client -quiet \
			-starttls smtp \
			-connect smtp.gmail.com:587 \
			-crlf 2> /dev/null
		}
		state=0
		compose 
		loop_smtp
		;;

	"read" | "")
		coproc IMAP {
			openssl s_client -quiet -connect imap.gmail.com:993 \
			-crlf 2> /dev/null
		}
		state=0
		loop_imap
		;;
esac
