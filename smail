#!/bin/sh

configure() {
	echo "Running configuration"
	[ -e "$HOME/.config/smail" ] || mkdir -p "$HOME/.config/smail"

	echo "Enter email:"
	read -r username
	echo "email=$(echo "$username" | base64 )" > "$configfile"

	echo "Enter password:"
	stty -echo
	read -r password
	stty echo
	echo "password=$(echo "$password" | base64 )" >> "$configfile"
	echo Done
}

retry() {
	echo Retrying...
	case $state in
		2)
			echo ehlo smtp.gmail.com > .in
			;;
		3)
			echo auth login > .in
			;;
		4)
			echo "$email" > .in
			;;
		5)
			echo "$password" > .in
			;;
		6)
			echo 'mail from: <'"$emaildec"'>' > .in
			;;
	esac
}

attachments() {
	echo "Enter file path:"
	read -r annex
	if [ -f "$annex" ]; then
		echo "Enter attachment name: [$(basename "$annex")]"
		read -r annexname
		[ "$annexname" = "" ] && annexname="$(basename "$annex")"

		echo "Content-Type: application/octet-stream" > .in
		echo "Content-Transfer-Encoding: base64" > .in
		echo "Content-Disposition: attachment;" > .in
		echo " filename= \"$annexname\"" > .in
		echo "" > .in
		base64 "$annex" > .in
	else
		echo "ERROR: File not found!"
	fi

	echo "Add another attachment(s)? [y/N]"
	read -r another
	[ "$another" = "y" ] && { echo "--$1" > .in; attachments "$1"; }
}


compose() {
	boundary="$(date | tr " :-" "wUX")"
	echo "Type email body (End with EOF on a single line)"
	echo "MIME-Version: 1.0" > .in
	echo "Content-Type: multipart/mixed;" > .in
	echo " boundary= \"$boundary\"" > .in
	echo "" > .in
	
	echo "--$boundary" > .in
	echo 'Content-Type: text/plain; charset=US-ASCII; format="flowed"' > .in
	echo "" > .in
	while read -r body
	do
		[ "$body" = "EOF" ] && break
		[ "$body" = "." ] && body=".."
		echo "$body" > .in
	done
	echo "" > .in
	echo "--$boundary" > .in

	echo "Insert attachment(s)? [y/N]"
	read -r attach
	[ "$attach" = "y" ] && attachments "$boundary"
	
	echo "--$boundary--" > .in
}

# Configuration step
configfile="$HOME/.config/smail/smail.conf"
[ -e "$configfile" ] || configure

email=$(grep email "$configfile" | cut -d '=' -f 2)
password=$(grep password "$configfile" | cut -d '=' -f 2)
emaildec=$(echo "$email" | base64 -d)

[ -p .in ] || mkfifo .in;
[ -p .out ] || mkfifo .out;

state=0


# start
openssl s_client -quiet -starttls smtp -connect smtp.gmail.com:587 -crlf < .in > .out 2> /dev/null &
state=1

echo Sending hello
echo ehlo smtp.gmail.com > .in
state=2
to=""

while :
do
	read -r msg < .out
	echo "received: $msg"
	case $msg in
		"250-"*)
			;;
		"250 SMTPUTF8"*)
			echo Logging in
			state=3
			echo auth login > .in
			;;
		"334 VXNlcm5hbWU6"*)
			echo Sending email
			state=4
			echo "$email" > .in
			;;

		"334 UGFzc3dvcmQ6"*)
			echo Sending password
			state=5
			echo "$password" > .in
			;;

		"235 2.7.0 Accepted"*)
			echo Logged in
			state=6
			echo 'mail from: <'"$emaildec"'>' > .in
			;;

		"250 2.0.0 OK"*)
			break
			;;

		"250 2.1.0 OK"*)
			echo "Type recipient:"
			read -r to
			echo Sending mail to $to
			state=7
			echo rcpt to: '<'"$to"'>' > .in
			;;

		"250 2.1.5 OK"*)
			echo Starting email
			echo data > .in
			;;

		"354  Go ahead"*)
			echo "To: $to" > .in
			echo "From: $emaildec" > .in
			
			echo "Input Subject:"
			read -r subj
			echo "Subject: $subj" > .in
			
			compose
			echo Done
			echo '.' > .in
			;;

		"451 4.4.2 Timeout"*)
			echo "Connection closed"
			break
			;;

		"501 5.5.2 Cannot Decode response"*)
			echo "Received error!"
			state=3
			retry
			;;
		"502 5.5.1 Unrecognized command"*)
			echo "Received error!"
			retry
			;;
		"503 5.5.1 MAIL first"*)
			echo "Received error!"
			state=6
			retry
			;;
		"530-5.7.0"*)
			;;
		"530 5.7.0"*)
			echo "Received error!"
			state=3
			retry
			;;
		"535 5.7.8"*)
			echo "Received error!"
			state=3
			retry
			;;
		"554 5.7.0"*)
			echo "Received error!"
			break
			;;
		*)
			echo "Unrecognized message"
			break
			;;
	esac
done

echo Quitting
echo quit > .in

rm .in .out
